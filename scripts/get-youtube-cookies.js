/**
 * YouTube Cookie Extractor
 *
 * Run this script to automatically log into YouTube and extract cookies
 * Usage: YOUTUBE_EMAIL=your@email.com YOUTUBE_PASSWORD=yourpass node scripts/get-youtube-cookies.js
 */

import puppeteer from 'puppeteer';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const email = process.env.YOUTUBE_EMAIL;
const password = process.env.YOUTUBE_PASSWORD;

if (!email || !password) {
  console.error('âŒ Error: YOUTUBE_EMAIL and YOUTUBE_PASSWORD environment variables are required');
  console.log('\nUsage:');
  console.log('  YOUTUBE_EMAIL=your@email.com YOUTUBE_PASSWORD=yourpass node scripts/get-youtube-cookies.js');
  process.exit(1);
}

async function getYouTubeCookies() {
  console.log('ðŸš€ Launching headless browser...');

  const browser = await puppeteer.launch({
    headless: true,
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      '--disable-gpu',
    ],
  });

  try {
    const page = await browser.newPage();

    // Set realistic viewport and user agent
    await page.setViewport({ width: 1920, height: 1080 });
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36');

    console.log('ðŸ“± Navigating to YouTube...');
    await page.goto('https://www.youtube.com', { waitUntil: 'networkidle2' });

    console.log('ðŸ”‘ Clicking Sign In...');
    await page.waitForSelector('a[aria-label="Sign in"]', { timeout: 10000 });
    await page.click('a[aria-label="Sign in"]');

    console.log('âœ‰ï¸  Entering email...');
    await page.waitForSelector('input[type="email"]', { timeout: 10000 });
    await page.type('input[type="email"]', email, { delay: 100 });
    await page.keyboard.press('Enter');

    console.log('ðŸ” Entering password...');
    await page.waitForSelector('input[type="password"]', { timeout: 10000 });
    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait for page to settle
    await page.type('input[type="password"]', password, { delay: 100 });
    await page.keyboard.press('Enter');

    console.log('â³ Waiting for login to complete...');
    await new Promise(resolve => setTimeout(resolve, 5000)); // Wait for redirect

    // Check if we're logged in by looking for the user avatar
    try {
      await page.waitForSelector('button[aria-label*="Account"]', { timeout: 10000 });
      console.log('âœ… Successfully logged in!');
    } catch (e) {
      console.error('âŒ Login may have failed or requires 2FA. Please check manually.');
      // Continue anyway to try to get cookies
    }

    console.log('ðŸª Extracting cookies...');
    const cookies = await page.cookies();

    // Convert to Netscape format
    const netscapeCookies = [
      '# Netscape HTTP Cookie File',
      '# This file was generated by the YouTube Cookie Extractor',
      '',
    ];

    for (const cookie of cookies) {
      const domain = cookie.domain.startsWith('.') ? cookie.domain : `.${cookie.domain}`;
      const flag = domain.startsWith('.') ? 'TRUE' : 'FALSE';
      const path = cookie.path || '/';
      const secure = cookie.secure ? 'TRUE' : 'FALSE';
      const expiration = cookie.expires || Math.floor(Date.now() / 1000) + (365 * 24 * 60 * 60); // 1 year
      const name = cookie.name;
      const value = cookie.value;

      netscapeCookies.push(`${domain}\t${flag}\t${path}\t${secure}\t${expiration}\t${name}\t${value}`);
    }

    // Save to cookies.txt in project root
    const cookiesPath = path.join(__dirname, '..', 'cookies.txt');
    fs.writeFileSync(cookiesPath, netscapeCookies.join('\n'), 'utf-8');

    console.log(`âœ… Cookies saved to: ${cookiesPath}`);
    console.log(`ðŸ“Š Total cookies: ${cookies.length}`);
    console.log('\nâœ¨ Done! Your application can now use these cookies to bypass YouTube bot detection.');
    console.log('   Cookies typically last 6-12 months before needing refresh.\n');

  } catch (error) {
    console.error('âŒ Error:', error.message);
    throw error;
  } finally {
    await browser.close();
  }
}

getYouTubeCookies().catch((error) => {
  console.error('Fatal error:', error);
  process.exit(1);
});
